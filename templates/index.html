{% extends "layout.html" %}

{% block title %}
    Manager
{% endblock %}

{% block main %}
    
    <div class="container">
        <h2>Manage Passwords</h2>
        <div class="row mt-4 mb-4">
            <div class="col">
                <form action="/search" method="post">
                    <input name="search" type="search" class="search" placeholder="search">
                    <button class="btn-outline-light rounded" type="submit">submit</button>
                </form>
            </div>
            <div class="col">
                <form action="/generate" method="post">
                    <input name="generate" type="button" class="btn-outline-dark" value="Generate Password">
                </form>
                <p class="mt-2 border">placeholder password</p>
            </div>
            <div class="col">
                <form action="/sort" method="post">
                    <select name="sort" class="form-select" aria-label="Default select example">
                        <option value="website">Sort by Website</option>
                        <option value="username">Sort by Username</option>
                        <option value="email">Sort by Email</option>
                        <option value="password">Sort by Password</option>
                        <option value="notes">Sort by Notes</option>
                    </select>
                    <button class="btn-outline-light rounded mt-2" type="submit">Sort</button>
                </form>
            </div>
        </div>

        <div class="form-control mt-4">
            <div class="row">
              <div class="col">
                <a href="/add" class="btn btn-primary">Add Password</a>
              </div>
              <!-- <div class="col">
                <a href="/edit/{{ password_id }}" class="btn btn-secondary">Edit Password</a>
              </div> -->
              <div class="col">
                <a href="/delete" class="btn btn-danger">Delete Password</a>
              </div>
            </div>
          </div>

        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th></th>
              <th>Website</th>
              <th>Username</th>
              <th>Email</th>
              <th>Password</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows%}
            <tr>
              <td>
                <a href="/edit/{{ row.id }}" class="btn btn-secondary">Edit</a>
              </td>
              <td>{% if row.website %}
                <!-- Check if website is provided -->
                <a href="{{ row.website }}" target="_blank">{{ row.website }}</a>
                {% else %}
                <!-- If website is not provided, display a placeholder -->
                N/A
                {% endif %}</td>
              <td>{{ row.username }}</td>
              <td>{{ row.email }}</td>
              <td>{% if pin_verified %}
                <!-- Show sensitive fields -->
                <span class="password-field">{{ row.password }}</span>
              {% else %}
                <!-- Show placeholder or message -->
                <button class="btn btn-link reveal-password" data-password="{{ row.password }}">Enter PIN to reveal</button>
              {% endif %}</td>
              <td>{{ row.notes }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <script>
      // Add event listeners to reveal password buttons
      document.querySelectorAll('.reveal-password').forEach(button => {
          button.addEventListener('click', () => {
              const pin = prompt('Enter PIN to reveal password:');

              // Send PIN to server for verification
              fetch('/verify_pin', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({
                          pin
                      })
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          // PIN verified, display password input field
                          const passwordContainer = button.parentElement;
                          passwordContainer.innerHTML = `
                              <span class="password-field">${button.getAttribute('data-password')}</span>
                          `;
                      } else {
                          // PIN verification failed, display error message
                          alert(data.message);
                      }
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      alert('An error occurred while verifying PIN.');
                  });
          });
      });
  </script>

{% endblock %}